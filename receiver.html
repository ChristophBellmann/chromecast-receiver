<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ReceiverÂ v2.5Â â€“Â CheeseÂ WheelÂ +Â Popâ€‘upsÂ Showcase</title>
<link rel="preconnect" href="https://www.gstatic.com">
<script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework_controls_dpad_tv.js"></script>
<style>
:root{
  --accent:#0af;
  --cheese:#f6d04d;
  --cheese-dark:#d49d32;
}
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;font-family:system-ui,sans-serif}
#cheeseCanvas{position:absolute;inset:0;z-index:15;pointer-events:none}
#splash{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:5}
#splash img{max-width:80%}
#splash #version{color:#fff;margin-top:1em;font-size:1.2em}
#timer{position:absolute;bottom:1em;left:50%;transform:translateX(-50%);color:#88f;font-size:1em;z-index:16;pointer-events:none}
#debug{position:absolute;bottom:3em;left:50%;transform:translateX(-50%);color:#0f0;font-size:1em;z-index:17;pointer-events:none;opacity:.7;transition:opacity .3s}
#menu{position:absolute;top:1em;left:50%;transform:translateX(-50%);background:#222;padding:.7em 1em;border-radius:12px;gap:.5em;z-index:20;display:flex;box-shadow:0 0 12px rgba(0,0,0,.8)}
#menu button{background:#fff;color:#000;border:none;padding:.5em 1em;font-size:1em;border-radius:8px;transition:transform .15s,background .15s}
#menu button.sel{outline:3px solid var(--accent);background:#eef}
cast-media-player{display:none}
</style>
</head>
<body tabindex="0">
<canvas id="cheeseCanvas"></canvas>
<div id="splash"><img src="https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png" alt="Loadingâ€¦"/><div id="version">v2.5Â +Â ðŸ§€</div></div>
<div id="timer">0.0Â s</div>
<div id="debug">BereitÂ â€“ keine Aktion</div>
<cast-media-player id="player"></cast-media-player>
<div id="menu">
  <button id="btn-popup1">PopupÂ 1</button>
  <button id="btn-popup2">PopupÂ 2</button>
  <button id="btn-popup3">PopupÂ 3</button>
  <button id="btn-stream">Stream</button>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  /* === CONFIG === */
  const ROTATION_PERIOD=15;           // seconds for full rotation
  const HOLE_COUNT=14;                // cheese holes
  const POPUP_DURATION=7000;          // milliseconds visible
  const IDLE_TEXT='BereitÂ â€“ keine Aktion';

  /* === DOM ELEMENTS === */
  const canvas=document.getElementById('cheeseCanvas');
  const ctx=canvas.getContext('2d');
  const timerEl=document.getElementById('timer');
  const debugEl=document.getElementById('debug');

  /* === COLORS FROM CSS VARS (safe for canvas) === */
  const css=getComputedStyle(document.documentElement);
  const COLOR_CHEESE=css.getPropertyValue('--cheese').trim()||'#f6d04d';
  const COLOR_CHEESE_DARK=css.getPropertyValue('--cheese-dark').trim()||'#d49d32';
  const COLOR_ACCENT=css.getPropertyValue('--accent').trim()||'#0af';

  /* === HELPER === */
  const holes=[];
  function log(msg){
    debugEl.textContent=msg;
    debugEl.style.opacity=1;
    clearTimeout(log.t);
    log.t=setTimeout(()=>{
      debugEl.textContent=IDLE_TEXT;
      debugEl.style.opacity=.7;
    },4000);
  }
  function resize(){
    canvas.width=innerWidth;
    canvas.height=innerHeight;
    generateHoles();
  }
  function generateHoles(){
    holes.length=0;
    const w=canvas.width,h=canvas.height,r=Math.min(w,h)*.3,cx=w/2,cy=h/2;
    for(let i=0;i<HOLE_COUNT;i++){
      const t=i/HOLE_COUNT*2*Math.PI;
      const hr=r*(.14+.05*Math.random());
      const hx=cx+Math.cos(t)*r*.65*(.8+.2*Math.random());
      const hy=cy+Math.sin(t)*r*.65*(.8+.2*Math.random());
      holes.push({hx,hy,hr});
    }
  }
  function flash(btn){
    btn.animate([{transform:'scale(1)'},{transform:'scale(0.9)'},{transform:'scale(1)'}],{duration:200});
  }

  /* === POPâ€‘UP STATE === */
  let popupActive=false,popupStart=0,popupType=0;
  function triggerPopup(type){
    popupActive=true;
    popupStart=performance.now();
    popupType=type;
    log(`PopupÂ ${type} getriggert`);
  }

  /* === DRAW LOOP === */
  let lastTs=null,angle=0,startTime=0;
  function draw(ts){
    if(!startTime){startTime=ts;}
    if(!lastTs){lastTs=ts;}
    const dt=(ts-lastTs)/1000;
    lastTs=ts;
    angle=(angle+dt*(2*Math.PI/ROTATION_PERIOD))%(2*Math.PI);
    timerEl.textContent=`${((ts-startTime)/1000).toFixed(1)}Â s`;

    const w=canvas.width,h=canvas.height,r=Math.min(w,h)*.3,cx=w/2,cy=h/2;
    ctx.clearRect(0,0,w,h);

    // Cheese wheel
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);
    ctx.translate(-cx,-cy);

    ctx.beginPath();
    ctx.arc(cx,cy,r,0,2*Math.PI);
    ctx.fillStyle=COLOR_CHEESE;
    ctx.fill();
    ctx.lineWidth=r*.05;
    ctx.strokeStyle=COLOR_CHEESE_DARK;
    ctx.stroke();

    ctx.fillStyle=COLOR_CHEESE_DARK;
    holes.forEach(({hx,hy,hr})=>{ctx.beginPath();ctx.arc(hx,hy,hr,0,2*Math.PI);ctx.fill();});
    ctx.restore();

    // Popâ€‘up overlay
    if(popupActive){
      const elapsed=performance.now()-popupStart;
      if(elapsed>POPUP_DURATION){
        popupActive=false;
      }else{
        drawPopup(w,h);
      }
    }

    requestAnimationFrame(draw);
  }

  function drawPopup(w,h){
    ctx.save();
    const boxW=w*0.6,boxH=h*0.28;
    const bx=(w-boxW)/2,by=(h-boxH)/2;
    ctx.globalAlpha=.9;
    ctx.fillStyle='#111';
    ctx.fillRect(bx,by,boxW,boxH);
    ctx.lineWidth=4;
    ctx.strokeStyle=COLOR_ACCENT;
    ctx.strokeRect(bx,by,boxW,boxH);
    ctx.globalAlpha=1;
    ctx.fillStyle='#fff';
    ctx.textAlign='center';
    ctx.textBaseline='middle';

    if(popupType===1){
      ctx.font=`${Math.min(boxH*.18,34)}px system-ui`;
      ctx.fillText('WillkommenÂ ðŸ‘‹',w/2,by+boxH*.35);
      ctx.font=`${Math.min(boxH*.14,24)}px system-ui`;
      ctx.fillText('DiesÂ istÂ PopupÂ 1',w/2,by+boxH*.65);
    }else if(popupType===2){
      ctx.font=`${Math.min(boxH*.18,34)}px system-ui`;
      ctx.fillText('ðŸŽ‰Â Erfolg!Â ðŸŽ‰',w/2,by+boxH*.5);
    }else if(popupType===3){
      ctx.font=`${Math.min(boxH*.18,34)}px system-ui`;
      ctx.fillText('âš ï¸Â AchtungÂ âš ï¸',w/2,by+boxH*.35);
      ctx.font=`${Math.min(boxH*.14,22)}px system-ui`;
      ctx.fillText('DiesÂ istÂ PopupÂ 3Â â€“Â Warnung',w/2,by+boxH*.65);
    }
    ctx.restore();
  }

  /* === MENU & BUTTONS === */
  const menu=document.getElementById('menu');
  const buttons=[...menu.querySelectorAll('button')];
  let selIdx=0;
  function select(idx){
    buttons[selIdx]?.classList.remove('sel');
    selIdx=((idx%buttons.length)+buttons.length)%buttons.length;
    buttons[selIdx].classList.add('sel');
  }
  window.addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='ArrowLeft') select(selIdx-1);
    else if(k==='ArrowRight') select(selIdx+1);
    else if(k==='Enter'||k==='OK') buttons[selIdx].click();
  });

  /* Attach click handlers */
  document.getElementById('btn-popup1').onclick=e=>{flash(e.currentTarget);triggerPopup(1);}  
  document.getElementById('btn-popup2').onclick=e=>{flash(e.currentTarget);triggerPopup(2);}  
  document.getElementById('btn-popup3').onclick=e=>{flash(e.currentTarget);triggerPopup(3);}  

  /* === CAST STREAM BUTTON === */
  const STREAM_NS='urn:x-cast:com.example.stream';
  const castCtx=cast.framework.CastReceiverContext.getInstance();
  const mgr=castCtx.getPlayerManager();
  const opts=new cast.framework.CastReceiverOptions();
  opts.disableIdleTimeout=true;
  mgr.setPlaybackConfig({autoResumeNumberOfSegments:1});
  castCtx.start(opts);
  const bus=castCtx.getCastMessageBus(STREAM_NS);

  document.getElementById('btn-stream').onclick=e=>{
    flash(e.currentTarget);
    document.getElementById('splash').style.display='none';
    log('Aktion:Â Stream');
    bus.send({type:'start'});
  };

  /* === INITIALISE === */
  resize();
  document.body.focus();
  select(0);
  triggerPopup(1);  // demo on startup
  requestAnimationFrame(draw);
  window.addEventListener('resize',resize);
});
</script>
</body>
</html>
