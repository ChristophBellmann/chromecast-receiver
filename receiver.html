<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Low-Latency Receiver + Cheese Wheel + Auto-Start v0.2</title>
    <!-- CAF Receiver SDK v3 + D-Pad support -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework_controls_dpad_tv.js"></script>
    <style>
      html, body {
        margin:0; padding:0;
        width:100%; height:100%;
        background:black; overflow:hidden;
      }
      /* 1) cheese wheel canvas over splash */
      #cheeseCanvas {
        position:absolute; inset:0;
        z-index:11;
        pointer-events:none;
      }
      /* 2) splash */
      #splash {
        position:absolute; inset:0;
        display:flex; flex-direction:column;
        align-items:center; justify-content:center;
        background:rgba(0,0,0,0.8);
        z-index:10;
      }
      #splash img { max-width:80%; }
      #splash #version {
        color:white; margin-top:1em; font-size:1.2em;
      }
      /* 3) hide the CAF player UI */
      cast-media-player { display:none; }
      /* 4) menu */
      #menu {
        position:absolute; top:10%; left:50%;
        transform:translateX(-50%);
        display:none;
        background:rgba(0,0,0,0.7);
        padding:1em; border-radius:8px;
        gap:1em; z-index:20;
        flex-direction:column;
      }
      #menu button {
        background:white; color:black; border:none;
        padding:0.5em 1em; font-size:1em;
      }
      #menu button:focus {
        outline:2px solid #0af;
      }
      /* 5) info overlay */
      #info {
        position:absolute; bottom:5%; left:5%;
        background:rgba(0,0,0,0.7); color:white;
        padding:1em; white-space:pre-line;
        z-index:20; display:none; font-size:0.9em;
      }
    </style>
  </head>
  <body>
    <!-- 1) cheese wheel -->
    <canvas id="cheeseCanvas"></canvas>

    <!-- 2) splash + version -->
    <div id="splash">
      <img src="https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png" alt="Loadingâ€¦">
      <div id="version">v0.2 + ðŸ§€</div>
    </div>

    <!-- 3) CAF player placeholder -->
    <cast-media-player id="player"></cast-media-player>

    <!-- 4) menu -->
    <div id="menu">
      <button id="menu-stream">Stream</button>
      <button id="menu-about">About</button>
    </div>

    <!-- 5) info -->
    <div id="info"></div>

    <script>
      // rotating cheese wheel
      const canvas = document.getElementById('cheeseCanvas');
      const ctx = canvas.getContext('2d');
      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();
      let angle = 0;
      function drawCheese() {
        const w = canvas.width, h = canvas.height;
        const r = Math.min(w,h)*0.3, cx = w/2, cy = h/2;
        ctx.clearRect(0,0,w,h);
        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(angle);
        ctx.translate(-cx,-cy);
        // wheel
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,2*Math.PI);
        ctx.fillStyle = '#2277cc';
        ctx.fill();
        ctx.lineWidth = r*0.05;
        ctx.strokeStyle = '#1155aa';
        ctx.stroke();
        // holes
        const count = 12;
        for(let i=0;i<count;i++){
          const t = (i/count)*2*Math.PI;
          const hr = r*(0.2+0.1*Math.random());
          const hx = cx+Math.cos(t)*r*0.6*(0.7+0.3*Math.random());
          const hy = cy+Math.sin(t)*r*0.6*(0.7+0.3*Math.random());
          ctx.beginPath();
          ctx.arc(hx,hy,hr,0,2*Math.PI);
          ctx.fillStyle = '#114477';
          ctx.fill();
        }
        ctx.restore();
        angle += 0.0002;
        requestAnimationFrame(drawCheese);
      }
      drawCheese();

      // CAF + menu + auto-start
      const STREAM_NS = 'urn:x-cast:com.example.stream';
      const context = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();
      const options = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      const cfg = playerManager.getPlaybackConfig();
      cfg.autoResumeNumberOfSegments = 1;
      playerManager.setPlaybackConfig(cfg);
      playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        req => { req.autoplay = true; return req; }
      );
      context.start(options);

      playerManager.addEventListener(
        cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
        () => document.getElementById('splash').style.display = 'none'
      );

      const bus = context.getCastMessageBus(STREAM_NS);
      const menu = document.getElementById('menu');
      const infoEl = document.getElementById('info');
      const items = Array.from(menu.querySelectorAll('button'));
      let idx = 0;

      document.addEventListener('keydown', e => {
        if (e.key==='ArrowUp'||e.key==='ArrowDown') {
          menu.style.display = 'flex';
          idx = 0; items[idx].focus();
          e.preventDefault();
        } else if (menu.style.display==='flex') {
          if (e.key==='ArrowUp')
            idx = (idx+items.length-1)%items.length;
          else if (e.key==='ArrowDown')
            idx = (idx+1)%items.length;
          else if (e.key==='Enter')
            items[idx].click();
          else if (e.key==='Escape')
            menu.style.display='none';
          items[idx].focus();
          e.preventDefault();
        }
      });

      document.getElementById('menu-stream')
        .addEventListener('click',() => {
          bus.send({type:'start'});
          document.getElementById('splash').style.display='none';
          menu.style.display='none';
        });

      document.getElementById('menu-about')
        .addEventListener('click',() => {
          const now = new Date().toLocaleTimeString();
          infoEl.textContent =
            `Hi Linda!\nHier ist ein selbstgebauter Player.\nLieben GruÃŸ, Christoph\n\nLocal Time: ${now}`;
          infoEl.style.display='block';
          setTimeout(()=>infoEl.style.display='none',5000);
          menu.style.display='none';
        });

      // auto-start after 20 seconds
      setTimeout(() => {
        bus.send({type:'start'});
        document.getElementById('splash').style.display='none';
      }, 20000);
    </script>
  </body>
</html>
