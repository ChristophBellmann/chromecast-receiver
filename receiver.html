<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Lowâ€‘Latency Receiver + Cheese Wheel + Autoâ€‘Start v0.5</title>
    <!-- CAF Receiver SDK v3 + Dâ€‘Pad support -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework_controls_dpad_tv.js"></script>
    <style>
      html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000}
      /* 1) cheese wheel behind everything */
      #cheeseCanvas{position:absolute;inset:0;z-index:10;pointer-events:none}
      /* 2) splash overlay under wheel */
      #splash{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:5}
      #splash img{max-width:80%}
      #splash #version{color:#fff;margin-top:1em;font-size:1.2em}
      /* 3) timer under wheel but above splash */
      #timer{position:absolute;top:60%;left:50%;transform:translateX(-50%);color:#88f;font-size:1.2em;z-index:8;pointer-events:none}
      /* 4) hide CAF player UI */
      cast-media-player{display:none}
      /* 5) menu sits on top */
      #menu{position:absolute;top:10%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);padding:1em;border-radius:8px;gap:1em;z-index:20;display:none;flex-direction:row}
      #menu button{background:#fff;color:#000;border:none;padding:.5em 1em;font-size:1em}
      #menu button:focus{outline:2px solid #0af}
      /* 6) simple info box (bottomâ€‘left) */
      #info{position:absolute;bottom:5%;left:5%;background:rgba(0,0,0,.7);color:#fff;padding:1em;white-space:pre-line;z-index:30;font-size:.9em;display:none}
    </style>
  </head>
  <!-- tabindex ensures body can receive focus and therefore key events -->
  <body tabindex="0">
    <!-- cheese wheel -->
    <canvas id="cheeseCanvas"></canvas>

    <!-- splash + version -->
    <div id="splash">
      <img src="https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png" alt="Loadingâ€¦" />
      <div id="version">v0.5 + ðŸ§€</div>
    </div>

    <!-- timer -->
    <div id="timer">Elapsed: 0.0 s</div>

    <!-- CAF player (hidden) -->
    <cast-media-player id="player"></cast-media-player>

    <!-- menu -->
    <div id="menu">
      <button id="menu-stream">Stream</button>
      <button id="menu-about">About</button>
    </div>

    <!-- info popâ€‘up (simple) -->
    <div id="info"></div>

    <script>
      /* ------------------------------------------------------------
       * CONSTANTS & STATE
       * ---------------------------------------------------------- */
      const ROTATION_PERIOD = 15;          // seconds per full revolution
      const AUTO_START_MS   = 20_000;      // autoâ€‘start after 20Â s
      const HOLE_COUNT      = 12;

      /* ------------------------------------------------------------
       * UTILITY â€“ ensure body can capture keyboard events
       * ---------------------------------------------------------- */
      window.addEventListener('load', () => document.body.focus());

      /* ------------------------------------------------------------
       * KEYBOARD / Dâ€‘PAD HANDLING
       * ---------------------------------------------------------- */
      const menu      = document.getElementById('menu');
      const buttons   = Array.from(menu.querySelectorAll('button'));
      let currentIdx  = 0;

      function handleKey(e){
        const { key } = e;

        // Open menu with Up / Down when hidden
        if((key === 'ArrowUp' || key === 'ArrowDown') && menu.style.display !== 'flex'){
          menu.style.display = 'flex';
          currentIdx = 0;
          buttons[currentIdx].focus();
          e.preventDefault();
          return;
        }

        // Navigate only if menu visible
        if(menu.style.display === 'flex'){
          if(key === 'ArrowLeft')      currentIdx = (currentIdx + buttons.length - 1) % buttons.length;
          else if(key === 'ArrowRight')currentIdx = (currentIdx + 1) % buttons.length;
          else if(key === 'Enter')     buttons[currentIdx].click();
          else if(key === 'Escape')    menu.style.display = 'none';

          buttons[currentIdx].focus();
          e.preventDefault();
        }
      }

      window.addEventListener('keydown', handleKey);

      /* ------------------------------------------------------------
       * CHEESE WHEEL & TIMER
       * ---------------------------------------------------------- */
      const canvas  = document.getElementById('cheeseCanvas');
      const ctx     = canvas.getContext('2d');
      const timerEl = document.getElementById('timer');

      let lastTs  = null;
      let angle   = 0;
      const startTime = performance.now();

      // preâ€‘compute hole positions & radii once (no perâ€‘frame flicker)
      const holes = [];
      function generateHoles(){
        holes.length = 0;
        const w = canvas.width, h = canvas.height;
        const r = Math.min(w, h) * 0.3;
        const cx = w / 2, cy = h / 2;
        for(let i = 0; i < HOLE_COUNT; i++){
          const t  = (i / HOLE_COUNT) * 2 * Math.PI;
          const hr = r * (0.15 + 0.05 * Math.random());
          const hx = cx + Math.cos(t) * r * 0.6 * (0.8 + 0.2 * Math.random());
          const hy = cy + Math.sin(t) * r * 0.6 * (0.8 + 0.2 * Math.random());
          holes.push({hx, hy, hr});
        }
      }

      function resizeCanvas(){
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
        generateHoles();
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      function draw(ts){
        if(lastTs === null) lastTs = ts;
        const deltaS = (ts - lastTs) / 1000;
        lastTs = ts;

        // advance angle: (2Ï€ / ROTATION_PERIOD) * deltaS
        angle = (angle + deltaS * (2 * Math.PI / ROTATION_PERIOD)) % (2 * Math.PI);

        // update timer text
        const elapsed = (performance.now() - startTime) / 1000;
        timerEl.textContent = `Elapsed: ${elapsed.toFixed(1)} s`;

        const w = canvas.width, h = canvas.height;
        const r = Math.min(w, h) * 0.3;
        const cx = w / 2, cy = h / 2;

        ctx.clearRect(0, 0, w, h);
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);
        ctx.translate(-cx, -cy);

        // wheel body
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
        ctx.fillStyle   = '#2277cc';
        ctx.fill();
        ctx.lineWidth   = r * 0.05;
        ctx.strokeStyle = '#1155aa';
        ctx.stroke();

        // holes (preâ€‘computed, so the pattern stays stable)
        ctx.fillStyle = '#114477';
        holes.forEach(({hx, hy, hr}) => {
          ctx.beginPath();
          ctx.arc(hx, hy, hr, 0, 2 * Math.PI);
          ctx.fill();
        });

        ctx.restore();
        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);

      /* ------------------------------------------------------------
       * CAF SETUP
       * ---------------------------------------------------------- */
      const STREAM_NS = 'urn:x-cast:com.example.stream';

      const castCtx = cast.framework.CastReceiverContext.getInstance();
      const mgr     = castCtx.getPlayerManager();

      const opts = new cast.framework.CastReceiverOptions();
      opts.disableIdleTimeout = true;

      const cfg = mgr.getPlaybackConfig();
      cfg.autoResumeNumberOfSegments = 1;
      mgr.setPlaybackConfig(cfg);

      mgr.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        req => { req.autoplay = true; return req; }
      );

      castCtx.start(opts);

      mgr.addEventListener(
        cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
        () => document.getElementById('splash').style.display = 'none'
      );

      /* ------------------------------------------------------------
       * MESSAGE BUS (no Ping)
       * ---------------------------------------------------------- */
      const bus  = castCtx.getCastMessageBus(STREAM_NS);
      const info = document.getElementById('info');

      /* ------------------------------------------------------------
       * MENU BUTTON CALLBACKS
       * ---------------------------------------------------------- */
      document.getElementById('menu-stream').addEventListener('click', () => {
        bus.send({ type: 'start' });
        document.getElementById('splash').style.display = 'none';
        menu.style.display = 'none';
      });

      document.getElementById('menu-about').addEventListener('click', () => {
        info.textContent = `Hi Linda!\nHier ist ein selbstgebauter Player.\nLieben GruÃŸ, Christoph`;
        info.style.display = 'block';
        // autoâ€‘hide after 5Â s
        setTimeout(() => info.style.display = 'none', 5000);
        menu.style.display = 'none';
      });

      /* ------------------------------------------------------------
       * AUTOâ€‘START AFTER 20Â s (cancelled when menu opens)
       * ---------------------------------------------------------- */
      const autoStart = setTimeout(() => {
        if(menu.style.display !== 'flex'){
          bus.send({ type: 'start' });
          document.getElementById('splash').style.display = 'none';
        }
      }, AUTO_START_MS);

      buttons.forEach(btn => btn.addEventListener('focus', () => clearTimeout(autoStart)));
    </script>
  </body>
</html>
