<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Low-Latency Receiver + Remote-Start</title>
    <!-- CAF SDK v3 & D-Pad support for built-in TVs -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework_controls_dpad_tv.js"></script>
    <style>
      html, body {
        margin:0; padding:0;
        width:100%; height:100%;
        background:black; overflow:hidden;
      }
      /* Splash screen */
      #splash {
        position:absolute; inset:0;
        display:flex; flex-direction:column;
        align-items:center; justify-content:center;
        background:black; z-index:10;
      }
      #splash img {
        max-width:80%;
        height:auto;
      }
      #splash #version {
        color:white; margin-top:1em;
        font-size:1.2em;
      }
      /* Key-catcher overlay to grab every key */
      #key-catcher {
        position:absolute; inset:0;
        z-index:20; outline:none;
      }
      /* CAF player */
      cast-media-player {
        position:absolute; inset:0;
        width:100%; height:100%;
        --media-background-color:black;
        --media-splash-image:
          url('https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png');
        --media-splash-image-size:contain;
        --media-splash-image-position:center center;
        --media-control-bar-display:none;
        z-index:5;
      }
      /* Menu overlay */
      #menu {
        position:absolute; top:30%; left:50%;
        transform:translateX(-50%);
        display:none; gap:1em;
        background:rgba(0,0,0,0.8);
        padding:1em; border-radius:8px;
        z-index:30;
        flex-direction:row;
      }
      #menu button {
        background:white; color:black;
        border:none; padding:0.5em 1em;
        font-size:1em;
      }
      #menu button:focus {
        outline:2px solid #0af;
      }
      /* Info overlay */
      #info {
        position:absolute; bottom:5%; left:5%;
        background:rgba(0,0,0,0.8); color:white;
        padding:1em; white-space:pre-line;
        z-index:30; display:none;
        font-size:0.9em;
      }
    </style>
  </head>
  <body>
    <!-- 1) Splash screen -->
    <div id="splash">
      <img src="https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png" alt="Loading…">
      <div id="version">v0.1</div>
    </div>

    <!-- 2) Full-screen focusable overlay -->
    <div id="key-catcher" tabindex="0"></div>

    <!-- 3) The CAF-managed video player -->
    <cast-media-player id="player"></cast-media-player>

    <!-- 4) Stream/About menu -->
    <div id="menu">
      <button id="menu-stream">Stream</button>
      <button id="menu-about">About</button>
    </div>

    <!-- 5) Info box for About message -->
    <div id="info"></div>

    <script>
      const STREAM_NS = 'urn:x-cast:com.example.stream';
      // Initialize CAF
      const context       = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();
      const options       = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      // Low-latency: resume after 1 segment
      const cfg = playerManager.getPlaybackConfig();
      cfg.autoResumeNumberOfSegments = 1;
      playerManager.setPlaybackConfig(cfg);
      // Force autoplay
      playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        req => { req.autoplay = true; return req; }
      );
      context.start(options);

      // No auto-hide of splash here!

      // Setup message bus for "start" event
      const bus = context.getCastMessageBus(STREAM_NS);

      // Menu logic
      const catcher = document.getElementById('key-catcher');
      const menu    = document.getElementById('menu');
      const info    = document.getElementById('info');
      const items   = Array.from(menu.querySelectorAll('button'));
      let idx = 0;

      // Keep focus on catcher
      window.addEventListener('load', () => catcher.focus());

      function showMenu() {
        menu.style.display = 'flex';
        idx = 0;
        items[idx].focus();
      }
      function hideMenu() {
        menu.style.display = 'none';
      }

      catcher.addEventListener('keydown', e => {
        switch (e.keyCode) {
          case 38: // Up
          case 40: // Down
            showMenu();
            break;
          case 37: // Left
            if (menu.style.display==='flex') {
              idx = (idx + items.length - 1) % items.length;
              items[idx].focus();
            }
            break;
          case 39: // Right
            if (menu.style.display==='flex') {
              idx = (idx + 1) % items.length;
              items[idx].focus();
            }
            break;
          case 13: // Enter
            if (menu.style.display==='flex') {
              items[idx].click();
            }
            break;
          case 27: // Esc
            hideMenu();
            break;
        }
        e.preventDefault();
      });

      // Stream button: hide splash & menu, send start msg
      document.getElementById('menu-stream').addEventListener('click', () => {
        document.getElementById('splash').style.display = 'none';
        hideMenu();
        bus.send({ type:'start' });
      });

      // About button: hide menu, show greeting
      document.getElementById('menu-about').addEventListener('click', () => {
        hideMenu();
        const now = new Date().toLocaleTimeString();
        info.textContent =
          `Hi Linda!\nHier ist ein selbstgebauter Player.\n` +
          `Lieben Gruß, Christoph\n\n` +
          `Local Time: ${now}`;
        info.style.display = 'block';
      });
    </script>
  </body>
</html>
