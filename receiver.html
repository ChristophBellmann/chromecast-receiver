<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lowâ€‘Latency Receiver + Cheese Wheel v2.2</title>
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework_controls_dpad_tv.js"></script>
  <style>
    :root{--accent:#0af}
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;font-family:system-ui,sans-serif}
    #cheeseCanvas{position:absolute;inset:0;z-index:10}
    #splash{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:5}
    #splash img{max-width:80%}
    #splash #version{color:#fff;margin-top:1em;font-size:1.2em}
    #timer{position:absolute;bottom:1em;left:50%;transform:translateX(-50%);color:#88f;font-size:1em;z-index:11;pointer-events:none}
    #debug{position:absolute;bottom:3em;left:50%;transform:translateX(-50%);color:#0f0;font-size:1em;z-index:12;pointer-events:none;opacity:.7;transition:opacity .3s}
    #menu{position:absolute;top:1em;left:50%;transform:translateX(-50%);background:#222;padding:.75em 1em;border-radius:12px;gap:.5em;z-index:20;display:flex;flex-direction:row;box-shadow:0 0 12px rgba(0,0,0,.8)}
    #menu button{background:#fff;color:#000;border:none;padding:.5em 1em;font-size:1em;border-radius:8px;transition:transform .15s,background .15s}
    #menu button.sel{outline:3px solid var(--accent);background:#eef}
    cast-media-player{display:none}
  </style>
</head>
<body tabindex="0">
  <canvas id="cheeseCanvas"></canvas>
  <div id="splash"><img src="https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png" alt="Loadingâ€¦"/><div id="version">v2.2 + ðŸ§€</div></div>
  <div id="timer">0.0Â s</div>
  <div id="debug">BereitÂ â€“ keine Aktion</div>
  <cast-media-player id="player"></cast-media-player>
  <div id="menu">
    <button id="btn-about">About</button>
    <button id="btn-popup2">PopupÂ 2</button>
    <button id="btn-stream">Stream</button>
  </div>
<script>
(()=>{
  const ROTATION_PERIOD=15,HOLE_COUNT=12,IDLE_TEXT='BereitÂ â€“ keine Aktion',POPUP_DURATION=3500;
  const canvas=document.getElementById('cheeseCanvas'),ctx=canvas.getContext('2d');
  const timerEl=document.getElementById('timer');
  const debugEl=document.getElementById('debug');
  function setIdle(){debugEl.textContent=IDLE_TEXT;debugEl.style.opacity=.7;}
  function showDebug(msg){debugEl.textContent=msg;debugEl.style.opacity=1;clearTimeout(showDebug.t);showDebug.t=setTimeout(setIdle,4000);}  
  /*â€‘â€‘ Cheese wheel setup â€‘â€‘*/
  const holes=[];let lastTs=null,angle=0,startTime;
  function genHoles(){holes.length=0;const w=canvas.width,h=canvas.height,r=Math.min(w,h)*.3,cx=w/2,cy=h/2;for(let i=0;i<HOLE_COUNT;i++){const t=i/HOLE_COUNT*2*Math.PI,hr=r*(.15+.05*Math.random()),hx=cx+Math.cos(t)*r*.6*(.8+.2*Math.random()),hy=cy+Math.sin(t)*r*.6*(.8+.2*Math.random());holes.push({hx,hy,hr});}}
  function resize(){canvas.width=innerWidth;canvas.height=innerHeight;genHoles();}
  window.addEventListener('resize',resize);
  /*â€‘â€‘ Popup state â€‘â€‘*/
  let popupActive=false,popupStart=0,popupType=1;
  function triggerPopup(type=1){popupActive=true;popupStart=performance.now();popupType=type;showDebug(`PopupÂ ${type} angezeigt`);} 
  /*â€‘â€‘ Main draw loop â€‘â€‘*/
  function draw(ts){if(!lastTs){lastTs=ts;startTime=ts;}const dt=(ts-lastTs)/1000;lastTs=ts;angle=(angle+dt*(2*Math.PI/ROTATION_PERIOD))%(2*Math.PI);
    timerEl.textContent=`${((ts-startTime)/1000).toFixed(1)}Â s`;
    const w=canvas.width,h=canvas.height,r=Math.min(w,h)*.3,cx=w/2,cy=h/2;
    ctx.clearRect(0,0,w,h);
    ctx.save();ctx.translate(cx,cy);ctx.rotate(angle);ctx.translate(-cx,-cy);
    ctx.beginPath();ctx.arc(cx,cy,r,0,2*Math.PI);ctx.fillStyle='#2277cc';ctx.fill();ctx.lineWidth=r*.05;ctx.strokeStyle='#1155aa';ctx.stroke();
    ctx.fillStyle='#114477';holes.forEach(({hx,hy,hr})=>{ctx.beginPath();ctx.arc(hx,hy,hr,0,2*Math.PI);ctx.fill();});ctx.restore();
    if(popupActive){const elapsed=performance.now()-popupStart;if(elapsed>POPUP_DURATION){popupActive=false;}else{
      ctx.save();const boxW=w*0.65,boxH=h*0.3;const bx=(w-boxW)/2,by=(h-boxH)/2;ctx.globalAlpha=.85;ctx.fillStyle='#222';ctx.fillRect(bx,by,boxW,boxH);ctx.lineWidth=4;ctx.strokeStyle='var(--accent)';ctx.strokeRect(bx,by,boxW,boxH);ctx.globalAlpha=1;ctx.fillStyle='#fff';ctx.textAlign='center';ctx.textBaseline='middle';
      if(popupType===1){ctx.font=`${Math.min(boxH*.18,36)}px system-ui`;ctx.fillText('HiÂ LindaÂ â€“ selbstgebauterÂ PlayerÂ ðŸŽµ',w/2,by+boxH*.4);ctx.font=`${Math.min(boxH*.14,24)}px system-ui`;ctx.fillText('LiebeÂ GrÃ¼ÃŸe,Â Christoph',w/2,by+boxH*.7);}else{ctx.font=`${Math.min(boxH*.2,38)}px system-ui`;ctx.fillText('ðŸŽ‰Â ZweitesÂ PopupÂ ðŸŽ‰',w/2,by+boxH*.5);}ctx.restore();}}
    requestAnimationFrame(draw);} 
  /*â€‘â€‘ Dâ€‘Pad / Menu handling â€‘â€‘*/
  const menu=document.getElementById('menu');
  const btns=[...menu.querySelectorAll('button')];let selIdx=0;
  function select(idx){btns[selIdx].classList.remove('sel');selIdx=((idx%btns.length)+btns.length)%btns.length;btns[selIdx].classList.add('sel');}
  window.addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='ArrowLeft')select(selIdx-1);else if(k==='ArrowRight')select(selIdx+1);else if(k==='Enter'||k==='OK')btns[selIdx].click();});
  /*â€‘â€‘ Click actions â€‘â€‘*/
  function flash(b){b.animate([{transform:'scale(1)'},{transform:'scale(0.9)'},{transform:'scale(1)'}],{duration:200});}
  btns[0].addEventListener('click',ev=>{flash(ev.currentTarget);triggerPopup(1);} );
  btns[1].addEventListener('click',ev=>{flash(ev.currentTarget);triggerPopup(2);} );
  /*â€‘â€‘ Cast receiver boilerplate â€‘â€‘*/
  const STREAM_NS='urn:x-cast:com.example.stream';
  const castCtx=cast.framework.CastReceiverContext.getInstance();
  const mgr=castCtx.getPlayerManager();
  const opts=new cast.framework.CastReceiverOptions();opts.disableIdleTimeout=true;mgr.setPlaybackConfig({autoResumeNumberOfSegments:1});castCtx.start(opts);
  const bus=castCtx.getCastMessageBus(STREAM_NS);
  btns[2].addEventListener('click',ev=>{flash(ev.currentTarget);document.getElementById('splash').style.display='none';showDebug('Aktion:Â StreamÂ gestartet');bus.send({type:'start'});} );
  /*â€‘â€‘ Init after DOM ready â€‘â€‘*/
  window.addEventListener('load',()=>{resize();document.body.focus();select(0);triggerPopup(1);requestAnimationFrame(draw);});
})();
</script>
</body>
</html>
