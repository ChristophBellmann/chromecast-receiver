<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Low-Latency Receiver v0.17</title>
    <!-- CAF Receiver SDK v3 + D-Pad support -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework_controls_dpad_tv.js"></script>
    <style>
      html, body {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        background: black; overflow: hidden;
      }
      /* 1) Splash screen */
      #splash {
        position: absolute; inset: 0;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        background: black; z-index: 10;
      }
      #splash img {
        max-width: 80%; height: auto;
      }
      #splash #version {
        color: white; margin-top: 1em; font-size: 1.2em;
      }
      /* 2) CAF player underneath */
      cast-media-player {
        position: absolute; inset: 0;
        --media-background-color: black;
        --media-splash-image: url('https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png');
        --media-splash-image-size: contain;
        --media-splash-image-position: center center;
        --media-control-bar-display: none;
        z-index: 5;
      }
      /* 3) Key-catcher (invisible until ready) */
      #key-catcher {
        position: absolute; inset: 0;
        display: none; /* we'll show it after splash loads */
        z-index: 15; outline: none;
      }
      /* 4) Vertical menu */
      #menu {
        position: absolute; top: 30%; left: 50%;
        transform: translateX(-50%);
        display: none; /* shown after splash load */
        flex-direction: column;
        gap: 1em;
        background: rgba(0,0,0,0.8);
        padding: 1em 2em; border-radius: 8px;
        z-index: 20;
      }
      #menu button {
        background: white; color: black;
        border: none; padding: 1em; font-size: 1rem;
      }
      #menu button:focus {
        outline: 2px solid #0af;
      }
      /* 5) Info overlay */
      #info {
        position: absolute; bottom: 5%; left: 5%;
        background: rgba(0,0,0,0.8); color: white;
        padding: 1em; white-space: pre-line;
        font-size: 0.9em; z-index: 20;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- 1) Splash screen -->
    <div id="splash">
      <img id="splash-img"
           src="https://christophbellmann.github.io/my-cast-receiver/splash-0.1.png"
           alt="Loading…">
      <div id="version">v0.17</div>
    </div>

    <!-- 2) CAF-managed player -->
    <cast-media-player id="player"></cast-media-player>

    <!-- 3) Invisible focusable key-catcher -->
    <div id="key-catcher" tabindex="0"></div>

    <!-- 4) Vertical menu -->
    <div id="menu">
      <button id="menu-stream">Stream</button>
      <button id="menu-about">About</button>
    </div>

    <!-- 5) Info box -->
    <div id="info"></div>

    <script>
      const STREAM_NS = 'urn:x-cast:com.example.stream';

      // Initialize CAF
      const context       = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();
      const options       = new cast.framework.CastReceiverOptions();
      options.disableIdleTimeout = true;
      // low-latency resume after 1 segment
      const cfg = playerManager.getPlaybackConfig();
      cfg.autoResumeNumberOfSegments = 1;
      playerManager.setPlaybackConfig(cfg);
      // force autoplay
      playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        req => { req.autoplay = true; return req; }
      );
      context.start(options);

      // Bus for debug & start messages
      const bus = context.getCastMessageBus(STREAM_NS);

      // DOM refs
      const splashImg = document.getElementById('splash-img');
      const catcher   = document.getElementById('key-catcher');
      const menu      = document.getElementById('menu');
      const info      = document.getElementById('info');
      const items     = Array.from(menu.querySelectorAll('button'));
      let idx = 0;

      function debug(msg) {
        bus.send({ type: 'debug', msg });
      }

      function showMenu() {
        debug('menu shown');
        menu.style.display = 'flex';
        idx = 0; items[idx].focus();
      }

      // After splash image loads (or if cached), show menu/key-catcher
      function onSplashReady() {
        debug('splash loaded');
        catcher.style.display = 'block';
        showMenu();
        catcher.focus();
      }
      splashImg.onload = onSplashReady;
      if (splashImg.complete) onSplashReady();

      // Handle D-pad & Enter & Back
      catcher.addEventListener('keydown', e => {
        debug(`keydown ${e.keyCode}`);
        e.preventDefault(); e.stopPropagation();
        switch (e.keyCode) {
          case 38: // Up
            idx = (idx + items.length - 1) % items.length;
            items[idx].focus();
            debug(`focus idx=${idx}`);
            break;
          case 40: // Down
            idx = (idx + 1) % items.length;
            items[idx].focus();
            debug(`focus idx=${idx}`);
            break;
          case 13: // Enter
            debug(`enter on idx=${idx}`);
            items[idx].click();
            break;
          case 8:  // Back / Backspace
          case 10009:
            debug('back pressed');
            // leave menu visible
            break;
        }
      });

      // Stream button
      document.getElementById('menu-stream').addEventListener('click', () => {
        debug('Stream clicked');
        document.getElementById('splash').style.display = 'none';
        bus.send({ type:'start' });
        catcher.focus();
      });

      // About button
      document.getElementById('menu-about').addEventListener('click', () => {
        debug('About clicked');
        const now = new Date().toLocaleTimeString();
        info.textContent =
          `Hi Linda!\nHier ist ein selbstgebauter Player.\nLieben Gruß, Christoph\n\n` +
          `Local Time: ${now}`;
        info.style.display = 'block';
        catcher.focus();
      });
    </script>
  </body>
</html>
